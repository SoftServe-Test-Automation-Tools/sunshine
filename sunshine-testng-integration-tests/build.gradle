dependencies {
    jar {
        manifest {
            attributes 'Main-Class': 'io.github.tatools.sunshine.SunshineTestNG'
            attributes "Class-Path": configurations.runtime.collect {
                "deps/" + it.getName()
            }.join(' ')
        }
    }
}

task copyToLib(type: Copy) {
    into "$buildDir/libs/deps"
    from configurations.runtime
}

build.dependsOn(copyToLib)

task runJar { Task task ->
    doLast {
        task.project.exec {
            executable "sh"
            args "-c", "cd build/libs/ && java -jar ${project.name}-${version}.jar " +
                    "| grep \"Total tests run: 3\""
        }
        task.project.exec {
            executable "sh"
            args "-c", "cd build/libs/ && java -jar ${project.name}-${version}.jar ../../src/main/resources/testng.xml " +
                    "| grep \"Total tests run: 2\""
        }
        task.project.exec {
            executable "sh"
            args "-c", "cd build/libs/ && java -jar ${project.name}-${version}.jar ../../src/main/resources/testng.yaml " +
                    "| grep \"Total tests run: 2\""
        }
    }
}
runJar.dependsOn(build)

task ready(dependsOn: runJar) {
    doLast {
        println("Sunshine TestNG integration testing is completed.")
    }
}

defaultTasks 'clean', 'ready'
